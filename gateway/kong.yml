# Phiên bản định dạng file cấu hình của Kong
_format_version: "3.0"
# Comment tùy chọn để biết file này dùng cho việc gì
_comment: "Kong declarative configuration for KLTN_2025 gateway. User: dxnghxn203. Timestamp: 2025-04-25 09:15:21 UTC"

#--------------------------------------------------
# Định nghĩa Backend Service (Dịch vụ đích)
# Kong sẽ kết nối đến dịch vụ này.
#--------------------------------------------------
services:
  - name: tracking-api-service # Tên định danh cho service backend
    # Sử dụng HTTPS vì Render thường cung cấp HTTPS endpoint
    protocol: https
    # !!! QUAN TRỌNG: Giá trị host sẽ được lấy từ biến môi trường TRACKING_API_HOST
    # Đảm bảo cú pháp là chính xác: ${TÊN_BIẾN}
    host: kltn-2025-tracking-api-ek34.onrender.com
    # Cổng chuẩn cho HTTPS
    port: 443
    # Đường dẫn cơ sở trên backend (thường là /)
    path: /
    # Thời gian chờ kết nối, đọc, ghi (milliseconds)
    connect_timeout: 6000
    read_timeout: 60000
    write_timeout: 60000
    # Số lần thử lại nếu kết nối thất bại
    retries: 3

#--------------------------------------------------
# Consumers và Credentials (Thông tin người dùng API Key)
# Cần thiết nếu bạn sử dụng plugin key-auth.
#--------------------------------------------------
consumers:
  - username: default-consumer # Tên định danh cho consumer (người dùng API key)
    keyauth_credentials:
      # !!! QUAN TRỌNG: API Key thực tế sẽ được lấy từ biến môi trường DEFAULT_API_KEY
      - key: ${DEFAULT_API_KEY}

#--------------------------------------------------
# Routes (Các tuyến đường định tuyến request)
# Định nghĩa cách các request từ client được khớp và chuyển đến service nào.
# Plugin key-auth chỉ được áp dụng cho các route cần bảo vệ.
#--------------------------------------------------
routes:
  # --- CÁC ROUTE CÔNG KHAI (Không yêu cầu API Key) ---

  - name: tracking-auth-public # Route cho các endpoint xác thực
    paths:
      - /v1/auth/ # Khớp với /v1/auth/, /v1/auth/login, /v1/auth/register,...
    # methods: [POST, GET, OPTIONS] # Có thể chỉ định phương thức nếu cần, nếu không sẽ cho phép tất cả
    strip_path: false # Giữ nguyên /v1/auth/ khi chuyển tiếp đến backend
    service: tracking-api-service # Chuyển tiếp đến service đã định nghĩa ở trên
    # Không có block 'plugins:' -> route này công khai

  - name: tracking-products-public-get # Route để lấy thông tin sản phẩm công khai
    paths:
      - /v1/products/ # Khớp /v1/products/ và /v1/products/some-id
      - /v1/product/ # Có thể thừa nếu đã có cái trên, nhưng để rõ ràng
    methods: [GET, OPTIONS] # Chỉ cho phép GET và OPTIONS công khai
    strip_path: false
    service: tracking-api-service
    # Không có 'plugins:' -> GET công khai

  - name: tracking-categories-public-get # Route lấy danh mục công khai
    paths:
      - /v1/category/
      - /v1/categories/
    methods: [GET, OPTIONS]
    strip_path: false
    service: tracking-api-service
    # Không có 'plugins:' -> GET công khai

  - name: tracking-root-public # Route cho đường dẫn gốc (/)
    paths:
      - /
    strip_path: false
    service: tracking-api-service
    # Không có 'plugins:' -> công khai

  # --- CÁC ROUTE ĐƯỢC BẢO VỆ (Yêu cầu API Key trong header 'apikey') ---

  - name: tracking-admin-protected # Route cho các endpoint quản trị
    paths:
      - /v1/admin/
    strip_path: false
    service: tracking-api-service
    plugins: # Áp dụng plugin cho route này
      - name: key-auth # Tên plugin
        config: # Cấu hình cho plugin key-auth
          key_names: ["apikey"] # Tìm API key trong header có tên 'apikey'
          hide_credentials: true # Không log giá trị key

  - name: tracking-users-protected # Route quản lý người dùng
    paths:
      - /v1/users/
      - /v1/user/
    strip_path: false
    service: tracking-api-service
    plugins:
      - name: key-auth
        config:
          key_names: ["apikey"]
          hide_credentials: true

  - name: tracking-order-protected # Route quản lý đơn hàng
    paths:
      - /v1/order/
    strip_path: false
    service: tracking-api-service
    plugins:
      - name: key-auth
        config:
          key_names: ["apikey"]
          hide_credentials: true

  - name: tracking-cart-protected # Route quản lý giỏ hàng
    paths:
      - /v1/cart/
    strip_path: false
    service: tracking-api-service
    plugins:
      - name: key-auth
        config:
          key_names: ["apikey"]
          hide_credentials: true

  - name: tracking-location-protected # Route quản lý địa chỉ
    paths:
      - /v1/location/
    strip_path: false
    service: tracking-api-service
    plugins:
      - name: key-auth
        config:
          key_names: ["apikey"]
          hide_credentials: true

  - name: tracking-review-protected # Route quản lý đánh giá
    paths:
      - /v1/review/
    strip_path: false
    service: tracking-api-service
    plugins:
      - name: key-auth
        config:
          key_names: ["apikey"]
          hide_credentials: true

  - name: tracking-comment-protected # Route quản lý bình luận
    paths:
      - /v1/comment/
    strip_path: false
    service: tracking-api-service
    plugins:
      - name: key-auth
        config:
          key_names: ["apikey"]
          hide_credentials: true

  - name: tracking-products-protected-modify # Bảo vệ các hành động sửa đổi sản phẩm
    paths:
      - /v1/products/
      - /v1/product/
    methods: [POST, PUT, PATCH, DELETE] # Chỉ bảo vệ các phương thức này
    strip_path: false
    service: tracking-api-service
    plugins:
      - name: key-auth
        config:
          key_names: ["apikey"]
          hide_credentials: true

  # ... (Thêm các route cần bảo vệ khác tương tự) ...
consumers:
  - username: default-consumer
    keyauth_credentials:
      # !!! TẠM THỜI HARDCODE API KEY Ở ĐÂY !!!
      - key: your_local_test_key_123 # Thay bằng key test của bạn
#--------------------------------------------------
# Plugins Toàn Cục (Global) hoặc Áp dụng cho Service
#--------------------------------------------------
plugins:
  # --- Plugin CORS (Cross-Origin Resource Sharing) ---
  # Áp dụng cho service 'tracking-api-service' để kiểm soát truy cập từ các domain khác
  - name: cors
    service: tracking-api-service # Chỉ áp dụng cho service này
    config:
      # Danh sách các nguồn gốc (origin) được phép truy cập.
      # Thay thế bằng URL frontend của bạn để an toàn hơn trong môi trường production.
      # Ví dụ: origins: ["http://localhost:3000", "https://your-frontend.onrender.com"]
      origins: ["*"] # Cho phép tất cả các nguồn gốc (tiện lợi cho test local, cần siết chặt sau)
      # Các phương thức HTTP được phép
      methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
      # Các header được phép gửi từ client (quan trọng: phải có 'apikey' nếu bạn dùng key-auth từ trình duyệt)
      headers: ["Content-Type", "Authorization", "apikey"]
      # Các header mà trình duyệt được phép đọc trong phản hồi
      exposed_headers: ["Content-Length", "Content-Type", "X-RateLimit-Limit", "X-RateLimit-Remaining"] # Ví dụ
      # Cho phép gửi thông tin xác thực (như cookie hoặc header Authorization)
      credentials: true
      # Thời gian cache kết quả của preflight request (OPTIONS) (tính bằng giây)
      max_age: 3600

  # --- KHÔNG đặt key-auth ở đây nếu muốn áp dụng có chọn lọc cho từng route ---